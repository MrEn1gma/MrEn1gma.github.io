<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Coconut - ASCIS CTF 2022" /><meta property="og:locale" content="en" /><meta name="description" content="Lời nói đầu" /><meta property="og:description" content="Lời nói đầu" /><link rel="canonical" href="https://mren1gma.github.io/posts/Coconut-ASCIS-CTF-2022/" /><meta property="og:url" content="https://mren1gma.github.io/posts/Coconut-ASCIS-CTF-2022/" /><meta property="og:site_name" content="Hai Nguyen" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-19T20:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Coconut - ASCIS CTF 2022" /><meta name="twitter:site" content="@nth2579" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-21T15:59:38+07:00","datePublished":"2022-10-19T20:00:00+07:00","description":"Lời nói đầu","headline":"Coconut - ASCIS CTF 2022","mainEntityOfPage":{"@type":"WebPage","@id":"https://mren1gma.github.io/posts/Coconut-ASCIS-CTF-2022/"},"url":"https://mren1gma.github.io/posts/Coconut-ASCIS-CTF-2022/"}</script><title>Coconut - ASCIS CTF 2022 | Hai Nguyen</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hai Nguyen"><meta name="application-name" content="Hai Nguyen"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/MrEn1gma/gh_pages_images/main/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hai Nguyen</a></div><div class="site-subtitle font-italic">Malware is my life</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/MrEn1gma" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/nth2579" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Coconut - ASCIS CTF 2022</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Coconut - ASCIS CTF 2022</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1666184400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 19, 2022 </em> </span> <span> Updated <em class="" data-ts="1666342778" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 21, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/nth2579">Hai Nguyen</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1679 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h1 id="lời-nói-đầu">Lời nói đầu</h1><ul><li><p>Vòng loại giải Sinh Viên An Toàn Thông Tin ASEAN đã kết thúc vào ngày 15/10. Đó là ngày đáng nhớ của mình cũng như các bạn khác tham gia vào ngày hôm đó, team mình - <code class="language-plaintext highlighter-rouge">th++</code> đã cố gắng giành được giải Khuyến Khích. Cảm xúc của mình lúc đó có buồn, có vui. Nhưng ít nhất mình cũng đã tận hưởng những ngày tháng cùng đám bạn tham gia SVATTT với tư cách là sinh viên năm cuối ĐH.</p><li><p>Bài <code class="language-plaintext highlighter-rouge">coconut</code> mình đã không kịp giải ra vào thời điểm đó, nhưng mình đã cố gắng giải bài này và cuối cùng mình cũng đã hoàn thành. Trước khi đi vào phần writeup, mình xin cảm ơn em <code class="language-plaintext highlighter-rouge">@mochi753</code> và <code class="language-plaintext highlighter-rouge">@EaZyQ</code> đã hỗ trợ anh giải ra được bài đó.</p></ul><h2 id="giới-thiệu"><span class="mr-2">Giới thiệu</span><a href="#giới-thiệu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Given files:</strong> <a href="https://github.com/MrEn1gma/Writeups/raw/main/ASCIS/2022/Coconut/Coconut.exe">coconut.exe</a><li><strong>Category</strong>: Reversing<li><strong>Summary</strong>: Crackme được viết bằng c# và sử dụng kỹ thuật che giấu đi code thật (không rõ chi tiết cái technique đó), bằng việc decrypt toàn bộ các hàm bị obfuscation. Sau đó reverse lại cái Crypto đó, mình tìm được key của flag1, flag thứ 2 phụ thuộc vào stack frame để cho ra key đúng, từ đó mình tìm ra được flag còn lại.</ul><h2 id="tổng-quan"><span class="mr-2">Tổng quan</span><a href="#tổng-quan" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Nhìn tổng quan toàn bộ các hàm của binary, dễ dàng nhận ra rằng tất cả các hàm đều bị obfuscated, ngoại trừ hàm <code class="language-plaintext highlighter-rouge">coconut_10</code> là nơi lưu trữ các giá trị nhằm phục vụ cho việc deobfuscate sau khi crackme được thực thi.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
	<span class="c1">// Token: 0x06000017 RID: 23 RVA: 0x00002FF4 File Offset: 0x000011F4</span>
	<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_10</span><span class="p">();</span>
		<span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_28</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_25</span><span class="p">(</span><span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_15</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_46</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Phần <code class="language-plaintext highlighter-rouge">Deobfuscate</code> sẽ giải mã toàn bộ các hàm và tiếp tục phân tích.</p><h2 id="deobfuscate"><span class="mr-2">Deobfuscate</span><a href="#deobfuscate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Mình lấy hàm <code class="language-plaintext highlighter-rouge">coconut_28</code> làm ví dụ: hàm này sử dụng để giải mã cái hàm <code class="language-plaintext highlighter-rouge">coconut_82</code>, nhưng do hàm <code class="language-plaintext highlighter-rouge">coconut_82</code> chưa được dnSpy nhận diện là 1 hàm, nên nó sẽ nhảy tới hàm <code class="language-plaintext highlighter-rouge">coconut_25</code> để decode. Để ý là có <code class="language-plaintext highlighter-rouge">coconut_meat28</code> và <code class="language-plaintext highlighter-rouge">coconut_water28</code> được load vào.</p><p>Hàm <code class="language-plaintext highlighter-rouge">coconut_25</code>:</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">object</span> <span class="nf">coconut_25</span><span class="p">(</span><span class="n">InvalidProgramException</span> <span class="n">e</span><span class="p">,</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">args</span><span class="p">,</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">uint</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">m</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">metadataToken</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StackTrace</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="nf">GetFrame</span><span class="p">(</span><span class="m">0</span><span class="p">).</span><span class="nf">GetMethod</span><span class="p">().</span><span class="n">MetadataToken</span><span class="p">;</span>
	<span class="n">Module</span> <span class="n">module</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Program</span><span class="p">).</span><span class="n">Module</span><span class="p">;</span>
	<span class="n">MethodInfo</span> <span class="n">methodInfo</span> <span class="p">=</span> <span class="p">(</span><span class="n">MethodInfo</span><span class="p">)</span><span class="n">module</span><span class="p">.</span><span class="nf">ResolveMethod</span><span class="p">(</span><span class="n">metadataToken</span><span class="p">);</span>
	<span class="n">MethodBase</span> <span class="n">methodBase</span> <span class="p">=</span> <span class="n">module</span><span class="p">.</span><span class="nf">ResolveMethod</span><span class="p">(</span><span class="n">metadataToken</span><span class="p">);</span>
	<span class="n">ParameterInfo</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">methodInfo</span><span class="p">.</span><span class="nf">GetParameters</span><span class="p">();</span>
	<span class="n">Type</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Type</span><span class="p">[</span><span class="n">parameters</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
	<span class="n">SignatureHelper</span> <span class="n">localVarSigHelper</span> <span class="p">=</span> <span class="n">SignatureHelper</span><span class="p">.</span><span class="nf">GetLocalVarSigHelper</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
	<span class="p">{</span>
		<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ParameterType</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Type</span> <span class="n">declaringType</span> <span class="p">=</span> <span class="n">methodBase</span><span class="p">.</span><span class="n">DeclaringType</span><span class="p">;</span>
	<span class="n">DynamicMethod</span> <span class="n">dynamicMethod</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicMethod</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">methodInfo</span><span class="p">.</span><span class="n">ReturnType</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">declaringType</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
	<span class="n">DynamicILInfo</span> <span class="n">dynamicILInfo</span> <span class="p">=</span> <span class="n">dynamicMethod</span><span class="p">.</span><span class="nf">GetDynamicILInfo</span><span class="p">();</span>
	<span class="n">MethodBody</span> <span class="n">methodBody</span> <span class="p">=</span> <span class="n">methodInfo</span><span class="p">.</span><span class="nf">GetMethodBody</span><span class="p">();</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="n">LocalVariableInfo</span> <span class="n">localVariableInfo</span> <span class="k">in</span> <span class="n">methodBody</span><span class="p">.</span><span class="n">LocalVariables</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">localVarSigHelper</span><span class="p">.</span><span class="nf">AddArgument</span><span class="p">(</span><span class="n">localVariableInfo</span><span class="p">.</span><span class="n">LocalType</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">byte</span><span class="p">[]</span> <span class="n">signature</span> <span class="p">=</span> <span class="n">localVarSigHelper</span><span class="p">.</span><span class="nf">GetSignature</span><span class="p">();</span>
	<span class="n">dynamicILInfo</span><span class="p">.</span><span class="nf">SetLocalSignature</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">uint</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">keyValuePair</span> <span class="k">in</span> <span class="n">m</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="n">keyValuePair</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
		<span class="kt">uint</span> <span class="n">key</span> <span class="p">=</span> <span class="n">keyValuePair</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tokenFor</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">&gt;=</span> <span class="m">1879048192</span> <span class="p">&amp;&amp;</span> <span class="k">value</span> <span class="p">&lt;</span> <span class="m">1879113727</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">tokenFor</span> <span class="p">=</span> <span class="n">dynamicILInfo</span><span class="p">.</span><span class="nf">GetTokenFor</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="nf">ResolveString</span><span class="p">(</span><span class="k">value</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">MemberInfo</span> <span class="n">memberInfo</span> <span class="p">=</span> <span class="n">declaringType</span><span class="p">.</span><span class="n">Module</span><span class="p">.</span><span class="nf">ResolveMember</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memberInfo</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"RtFieldInfo"</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">tokenFor</span> <span class="p">=</span> <span class="n">dynamicILInfo</span><span class="p">.</span><span class="nf">GetTokenFor</span><span class="p">(((</span><span class="n">FieldInfo</span><span class="p">)</span><span class="n">memberInfo</span><span class="p">).</span><span class="n">FieldHandle</span><span class="p">,</span> <span class="p">((</span><span class="n">TypeInfo</span><span class="p">)((</span><span class="n">FieldInfo</span><span class="p">)</span><span class="n">memberInfo</span><span class="p">).</span><span class="n">DeclaringType</span><span class="p">).</span><span class="n">TypeHandle</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memberInfo</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"RuntimeType"</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">tokenFor</span> <span class="p">=</span> <span class="n">dynamicILInfo</span><span class="p">.</span><span class="nf">GetTokenFor</span><span class="p">(((</span><span class="n">TypeInfo</span><span class="p">)</span><span class="n">memberInfo</span><span class="p">).</span><span class="n">TypeHandle</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memberInfo</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">".ctor"</span> <span class="p">||</span> <span class="n">memberInfo</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">".cctor"</span><span class="p">)</span>
			<span class="p">{</span>
                <span class="n">tokenFor</span> <span class="p">=</span> <span class="n">dynamicILInfo</span><span class="p">.</span><span class="nf">GetTokenFor</span><span class="p">(((</span><span class="n">ConstructorInfo</span><span class="p">)</span><span class="n">memberInfo</span><span class="p">).</span><span class="n">MethodHandle</span><span class="p">,</span> <span class="p">((</span><span class="n">TypeInfo</span><span class="p">)((</span><span class="n">ConstructorInfo</span><span class="p">)</span><span class="n">memberInfo</span><span class="p">).</span><span class="n">DeclaringType</span><span class="p">).</span><span class="n">TypeHandle</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">tokenFor</span> <span class="p">=</span> <span class="n">dynamicILInfo</span><span class="p">.</span><span class="nf">GetTokenFor</span><span class="p">(((</span><span class="n">MethodInfo</span><span class="p">)</span><span class="n">memberInfo</span><span class="p">).</span><span class="n">MethodHandle</span><span class="p">,</span> <span class="p">((</span><span class="n">TypeInfo</span><span class="p">)((</span><span class="n">MethodInfo</span><span class="p">)</span><span class="n">memberInfo</span><span class="p">).</span><span class="n">DeclaringType</span><span class="p">).</span><span class="n">TypeHandle</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">b</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="n">tokenFor</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[(</span><span class="kt">int</span><span class="p">)(</span><span class="n">key</span> <span class="p">+</span> <span class="m">1U</span><span class="p">)]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">tokenFor</span> <span class="p">&gt;&gt;</span> <span class="m">8</span><span class="p">);</span>
		<span class="n">b</span><span class="p">[(</span><span class="kt">int</span><span class="p">)(</span><span class="n">key</span> <span class="p">+</span> <span class="m">2U</span><span class="p">)]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">tokenFor</span> <span class="p">&gt;&gt;</span> <span class="m">16</span><span class="p">);</span>
		<span class="n">b</span><span class="p">[(</span><span class="kt">int</span><span class="p">)(</span><span class="n">key</span> <span class="p">+</span> <span class="m">3U</span><span class="p">)]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">tokenFor</span> <span class="p">&gt;&gt;</span> <span class="m">24</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dynamicILInfo</span><span class="p">.</span><span class="nf">SetCode</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">methodBody</span><span class="p">.</span><span class="n">MaxStackSize</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dynamicMethod</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>MetadataToken thực hiện load token nhằm lấy data của hàm <code class="language-plaintext highlighter-rouge">coconut_82</code>, sau đó thực hiện vòng lặp để nạp vào các section và tiến hành giải mã các byte của hàm <code class="language-plaintext highlighter-rouge">coconut_82</code>, cuối cùng thực thi chúng bằng method <code class="language-plaintext highlighter-rouge">dynamicMethod.Invoke(null, args)</code>.</p><ul><li>metataToken:</ul><p><img data-src="/assets/img/ASCIScoconut_img/photo_2022-10-21_10-27-46.jpg" alt="metatdata" data-proofer-ignore></p><ul><li>Hàm giải mã:</ul><pre><code class="language-C#">b[(int)key] = (byte)tokenFor;
b[(int)(key + 1U)] = (byte)(tokenFor &gt;&gt; 8);
b[(int)(key + 2U)] = (byte)(tokenFor &gt;&gt; 16);
b[(int)(key + 3U)] = (byte)(tokenFor &gt;&gt; 24);
</code></pre><p><strong>Nhận xét:</strong> hàm <code class="language-plaintext highlighter-rouge">coconut_25</code> chỉ thực hiện giải mã bằng cách dùng toán tử <code class="language-plaintext highlighter-rouge">shift right</code> lần lượt là 8, 16, 24, mình có thể viết script để thực hiện giải mã:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">ASCIS_coconut_decrypt</span><span class="p">(</span><span class="n">meat</span><span class="p">,</span> <span class="n">water</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">meat</span><span class="p">)):</span>
        <span class="n">water</span><span class="p">[</span><span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">water</span><span class="p">[</span><span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">water</span><span class="p">[</span><span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">water</span><span class="p">[</span><span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">meat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>

    <span class="k">return</span> <span class="n">water</span>
</pre></table></code></div></div><p>Sau đó sửa các byte dựa trên địa chỉ của <code class="language-plaintext highlighter-rouge">water</code> tương ứng với hàm cần giải mã, trong trường hợp ở đây là <code class="language-plaintext highlighter-rouge">water28</code> có địa chỉ là <code class="language-plaintext highlighter-rouge">0x7bc + 21</code> với 21 là size của <code class="language-plaintext highlighter-rouge">water28</code>.</p><p>NOTE: để tìm chính xác địa chỉ của <code class="language-plaintext highlighter-rouge">water28</code>, mình sử dụng chức năng <code class="language-plaintext highlighter-rouge">Show Instructions in Hex Editor</code>.</p><p>Full script mình để ở đây: <a href="https://github.com/MrEn1gma/Writeups/blob/1e22e7dfb687829b0fbf2713c22e0779922c4b8e/ASCIS/2022/Coconut/decrypt.py">deobfuscate_coconut</a></p><h2 id="phân-tích-coconutexe-patched"><span class="mr-2">Phân tích coconut.exe (patched)</span><a href="#phân-tích-coconutexe-patched" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Sau khi decrypt xong, hàm <code class="language-plaintext highlighter-rouge">coconut_82</code> và các hàm khác đã được giải mã.</p><ul><li>Nhập key và read key.<div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">coconut_82</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"Enter key: "</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><li>Hàm xử lý input</ul><pre><code class="language-C#">public static string coconut_51(string s)
{
	return BitConverter.ToString(Encoding.Default.GetBytes(s)).Replace("-", "");
}
</code></pre><p>Quan sát hàm <code class="language-plaintext highlighter-rouge">coconut_51</code>, mình nhận thấy nó thực hiện 2 bước để check. Đầu tiên chúng sẽ convert các ký tự ASCII sang chuỗi số thập lục phân và xoá các ký tự <code class="language-plaintext highlighter-rouge">-</code> để thành 1 chuỗi hexstring. Tiếp tục đi vào hàm <code class="language-plaintext highlighter-rouge">coconut_52</code> để thực hiện check key.</p><p><img data-src="/assets/img/ASCIScoconut_img/photo_2022-10-21_10-54-53.jpg" alt="debug_value" data-proofer-ignore></p><ul><li>Hàm <code class="language-plaintext highlighter-rouge">coconut_52</code>:</ul><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">coconut_52</span><span class="p">(</span><span class="kt">string</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">BigInteger</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">NumberStyles</span><span class="p">.</span><span class="n">HexNumber</span><span class="p">)</span> <span class="p">*</span> <span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_89</span><span class="p">(</span><span class="n">Coconut</span><span class="p">.</span><span class="n">water_01</span><span class="p">)</span> <span class="p">%</span> <span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_89</span><span class="p">(</span><span class="n">Coconut</span><span class="p">.</span><span class="n">water_02</span><span class="p">)</span> <span class="p">==</span> <span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_89</span><span class="p">(</span><span class="n">Coconut</span><span class="p">.</span><span class="n">water_03</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="n">BigInteger</span> <span class="nf">coconut_98</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="kt">byte</span> <span class="n">b2</span> <span class="k">in</span> <span class="n">b</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b2</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">text</span> <span class="p">+=</span> <span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="n">b2</span> <span class="p">+</span> <span class="m">48</span><span class="p">)).</span><span class="nf">ToString</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">text</span> <span class="p">+=</span> <span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="n">b2</span> <span class="p">+</span> <span class="m">87</span><span class="p">)).</span><span class="nf">ToString</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">BigInteger</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">NumberStyles</span><span class="p">.</span><span class="n">HexNumber</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Quan sát hàm <code class="language-plaintext highlighter-rouge">coconut_98</code>, chúng sẽ load lần lượt các giá trị <code class="language-plaintext highlighter-rouge">Coconut.water_01</code>, <code class="language-plaintext highlighter-rouge">Coconut.water_02</code>, <code class="language-plaintext highlighter-rouge">Coconut.water_03</code> để tính toán ra các số nguyên lớn và sau khi input được convert sang chuỗi hexstring, method <code class="language-plaintext highlighter-rouge">BigInteger</code> trong hàm <code class="language-plaintext highlighter-rouge">coconut_52</code> prase chuỗi hexstring thành số nguyên lớn. Sau đó thực hiện tính toán để check key.</p><p><strong>Nhận xét:</strong> Một bài toán liên quan tới Crypto, tuy nhiên thì mình không đi sâu về phần giải thích mà chỉ đưa ra phần giải.</p><pre><code class="language-txt">-- PROBLEM --
passwd * coconut_water01 % coconut_water02 = coconut_water03
=&gt; passwd = (coconut_water03 * inverse(coconut_water01, coconut_water02)) % coconut_water02
</code></pre><ul><li>Thực hiện bằng python script</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">passwd</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">((</span><span class="n">ASCIS_coconut_52_BIGNUMBER</span><span class="p">(</span><span class="n">coconut_water03</span><span class="p">)</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="n">ASCIS_coconut_52_BIGNUMBER</span><span class="p">(</span><span class="n">coconut_water01</span><span class="p">),</span> <span class="n">ASCIS_coconut_52_BIGNUMBER</span><span class="p">(</span><span class="n">coconut_water02</span><span class="p">)))</span> <span class="o">%</span> <span class="n">ASCIS_coconut_52_BIGNUMBER</span><span class="p">(</span><span class="n">coconut_water02</span><span class="p">))</span>
</pre></table></code></div></div><p>Chạy file script trên, mình đã tìm ra được key: <code class="language-plaintext highlighter-rouge">Ytd_is_history_Tmr_is_a_mystery!</code>. Lúc này mình thử test trên powershell thì ra được thông báo dưới đây:</p><p><img data-src="/assets/img/ASCIScoconut_img/photo_2022-10-21_13-33-41.jpg" alt="error_flag" data-proofer-ignore></p><p>Tuy nhiên trong lúc chạy thì file <code class="language-plaintext highlighter-rouge">PANDA.png</code> đã được dump ra:</p><p><img data-src="/assets/img/ASCIScoconut_img/PANDA.png" alt="flag1" data-proofer-ignore></p><p>Như vậy mình đã có được 1 phần của flag: <code class="language-plaintext highlighter-rouge">ASCIS{7hat's_Why_7h3y_call_it</code>. Tuy nhiên phần còn lại của flag thì mình chưa biết, vì cái thông báo trên powershell lúc nãy đã cho mình biết được nhiệm vụ tiếp theo phải bypass được đoạn đó để tìm ra flag còn lại.</p><h2 id="bypass-the-time"><span class="mr-2">Bypass the Time</span><a href="#bypass-the-time" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Phân tích lại file sau khi đã deobfuscated, sau khi đã decrypt ra file <code class="language-plaintext highlighter-rouge">PANDA.jpg</code> bằng thuật toán AES, nó nhảy vào hàm <code class="language-plaintext highlighter-rouge">coconut_06</code> và tới hàm <code class="language-plaintext highlighter-rouge">coconut_60</code>:</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">coconut_60</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Year</span> <span class="p">&lt;</span> <span class="m">3022</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Waiting for a thousand year."</span><span class="p">);</span>
		<span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">86400000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">Coconut</span><span class="p">.</span><span class="nf">coconut_36</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Đoạn check chỉ kiểm tra năm hiện tại trên máy tính có lớn hơn 3022 hay không, ngược lại nó sẽ nhảy vào vòng lặp “vô tận”. Để pass nó, bạn đọc có thể edit lại method và sửa dấu <code class="language-plaintext highlighter-rouge">&lt;</code> thành <code class="language-plaintext highlighter-rouge">&gt;</code>. Lưu lại và chạy file đã patched.</p><p><img data-src="/assets/img/ASCIScoconut_img/photo_2022-10-21_14-31-06.jpg" alt="error_flag2" data-proofer-ignore></p><p>Lần này mình đã dump ra được file <code class="language-plaintext highlighter-rouge">DRAGON_WARRIOR.png</code>, nhưng có gì đó không đúng….</p><p>Debug qua đoạn dump ra file <code class="language-plaintext highlighter-rouge">DRAGON_WARRIOR.png</code> cụ thể ở đây là hàm <code class="language-plaintext highlighter-rouge">coconut_16</code>, mình thấy nó in ra key: <code class="language-plaintext highlighter-rouge">Void coconut_63()System.String coconut_16()</code></p><p><img data-src="/assets/img/ASCIScoconut_img/photo_2022-10-21_14-52-32.jpg" alt="debug2" data-proofer-ignore></p><p>Phân tích hàm <code class="language-plaintext highlighter-rouge">coconut_61</code>, nó đang lấy Frame dựa trên stackTrace để lấy tên hàm con thuộc <code class="language-plaintext highlighter-rouge">coconut_61</code>,trong trường hợp này là hàm <code class="language-plaintext highlighter-rouge">coconut_61</code> và <code class="language-plaintext highlighter-rouge">coconut_63</code>. Cho nên mới có kết quả khi return cái key trên. Tuy nhiên, key đó không đúng vì lúc nãy mình đã chạy thử file patched trước đó.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">coconut_61</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">StackTrace</span> <span class="n">stackTrace</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StackTrace</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">stackTrace</span><span class="p">.</span><span class="nf">GetFrame</span><span class="p">(</span><span class="m">2</span><span class="p">).</span><span class="nf">GetMethod</span><span class="p">().</span><span class="nf">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="n">stackTrace</span><span class="p">.</span><span class="nf">GetFrame</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="nf">GetMethod</span><span class="p">().</span><span class="nf">ToString</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Vậy vấn đề ở đây là gì ?</strong></p><p>Quay trở lại hàm <code class="language-plaintext highlighter-rouge">coconut_36</code>, try-catch sẽ thực hiện nhảy vào hàm <code class="language-plaintext highlighter-rouge">coconut_63</code>, nếu như hàm đó không bị lỗi và ngược lại nó sẽ nhảy vào hàm <code class="language-plaintext highlighter-rouge">coconut_25</code>. Vấn đề là khi trace tới <code class="language-plaintext highlighter-rouge">coconut_63</code> nó không bị lỗi bởi vì mình đã deobfuscate hàm đó rồi. Đó chính là mấu chốt của bài toán trên, vì vậy mình buộc phải trace vào hàm <code class="language-plaintext highlighter-rouge">coconut_25</code> thì mới return về key đúng.</p><p><strong>Giải pháp:</strong>Chuyển số 3022 ra dạng hexadecimal ta được <code class="language-plaintext highlighter-rouge">0x0bce</code>, tức là <code class="language-plaintext highlighter-rouge">206 và 11</code>. Đồng thời mở file Coconut.exe ban đầu (chưa modified gì hết), ta lấy tất cả bytes của <code class="language-plaintext highlighter-rouge">water06</code>:</p><p><img data-src="/assets/img/ASCIScoconut_img/photo_2022-10-21_15-33-39.jpg" alt="warer06" data-proofer-ignore></p><p>Tìm số 206 và 11, mình thấy nó nằm trong mảng <code class="language-plaintext highlighter-rouge">water06</code>. Pattern đó chính là số 3022 thuộc đoạn <code class="language-plaintext highlighter-rouge">while (DateTime.Now.Year &gt; 3022)</code>, mình có thể thay số 3022 thành số nào nhỏ hơn năm hiện tại trên máy (ở đây là năm 2022), ở đây mình sẽ dùng số <code class="language-plaintext highlighter-rouge">2019</code> tức là <code class="language-plaintext highlighter-rouge">227 07</code> dưới dạng bytearray. Sau đó patch 2 số đó vào vị trí của số <code class="language-plaintext highlighter-rouge">206 và 11</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">water06</code> sau khi được modified:</ul><p><img data-src="/assets/img/ASCIScoconut_img/photo_2022-10-21_15-40-44.jpg" alt="warer06_1" data-proofer-ignore></p><p>Cuối cùng, chạy file sau khi sửa, ta đã thành công dump được file <code class="language-plaintext highlighter-rouge">DRAGON_WARRIOR.png</code>:</p><p><img data-src="/assets/img/ASCIScoconut_img/DRAGON WARRIOR.png" alt="flag2" data-proofer-ignore></p><p>Flag thứ 2: <code class="language-plaintext highlighter-rouge">_Prrrres3nt!!!!}</code></p><p>Ghép lại flag1 và flag2, ta được 1 flag hoàn chỉnh: <code class="language-plaintext highlighter-rouge">ASCIS{7hat's_Why_7h3y_call_it_Prrrres3nt!!!!}</code> Full script solve mình để ở đây: <a href="https://github.com/MrEn1gma/Writeups/blob/main/ASCIS/2022/Coconut/solve.py">solve</a></p><h2 id="end"><span class="mr-2">END</span><a href="#end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Hết rồi =)))</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/re/'>RE</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/obfuscation/" class="post-tag no-text-decoration" >Obfuscation</a> <a href="/tags/ascis/" class="post-tag no-text-decoration" >ascis</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Coconut+-+ASCIS+CTF+2022+-+Hai+Nguyen&url=https%3A%2F%2Fmren1gma.github.io%2Fposts%2FCoconut-ASCIS-CTF-2022%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Coconut+-+ASCIS+CTF+2022+-+Hai+Nguyen&u=https%3A%2F%2Fmren1gma.github.io%2Fposts%2FCoconut-ASCIS-CTF-2022%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmren1gma.github.io%2Fposts%2FCoconut-ASCIS-CTF-2022%2F&text=Coconut+-+ASCIS+CTF+2022+-+Hai+Nguyen" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Coconut-ASCIS-CTF-2022/">Coconut - ASCIS CTF 2022</a><li><a href="/posts/findtheflag-extremecoder/">findtheflag.exe - defeating custom Self Modify with IDAPython</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ascis/">ascis</a> <a class="post-tag" href="/tags/idapython/">idapython</a> <a class="post-tag" href="/tags/obfuscation/">Obfuscation</a> <a class="post-tag" href="/tags/selfmodify/">selfmodify</a> <a class="post-tag" href="/tags/z3/">z3</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/findtheflag-extremecoder/"><div class="card-body"> <em class="small" data-ts="1662534000" data-df="ll" > Sep 7, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>findtheflag.exe - defeating custom Self Modify with IDAPython</h3><div class="text-muted small"><p> Lời nói đầu Crackme trên do mình tình cờ đọc blog của anh m4n0w4r về writeup có trên tut4you. Bài này tuy dùng kỹ thuật khá là cổ điển nhưng ít nhiều nó giúp mình có thêm cái nhìn rõ hơn về kỹ thu...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/findtheflag-extremecoder/" class="btn btn-outline-primary" prompt="Older"><p>findtheflag.exe - defeating custom Self Modify with IDAPython</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/nth2579">Hai Nguyen</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ascis/">ascis</a> <a class="post-tag" href="/tags/idapython/">idapython</a> <a class="post-tag" href="/tags/obfuscation/">Obfuscation</a> <a class="post-tag" href="/tags/selfmodify/">selfmodify</a> <a class="post-tag" href="/tags/z3/">z3</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
