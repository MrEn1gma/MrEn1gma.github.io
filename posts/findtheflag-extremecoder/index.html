<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="findtheflag.exe - defeating custom Self Modify with IDAPython" /><meta property="og:locale" content="en" /><meta name="description" content="Lời nói đầu" /><meta property="og:description" content="Lời nói đầu" /><link rel="canonical" href="https://mren1gma.github.io/posts/findtheflag-extremecoder/" /><meta property="og:url" content="https://mren1gma.github.io/posts/findtheflag-extremecoder/" /><meta property="og:site_name" content="Hai Nguyen" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-07T14:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="findtheflag.exe - defeating custom Self Modify with IDAPython" /><meta name="twitter:site" content="@nth2579" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-07T14:41:43+07:00","datePublished":"2022-09-07T14:00:00+07:00","description":"Lời nói đầu","headline":"findtheflag.exe - defeating custom Self Modify with IDAPython","mainEntityOfPage":{"@type":"WebPage","@id":"https://mren1gma.github.io/posts/findtheflag-extremecoder/"},"url":"https://mren1gma.github.io/posts/findtheflag-extremecoder/"}</script><title>findtheflag.exe - defeating custom Self Modify with IDAPython | Hai Nguyen</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hai Nguyen"><meta name="application-name" content="Hai Nguyen"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/MrEn1gma/gh_pages_images/main/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hai Nguyen</a></div><div class="site-subtitle font-italic">Malware is my life</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/MrEn1gma" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/nth2579" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>findtheflag.exe - defeating custom Self Modify with IDAPython</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>findtheflag.exe - defeating custom Self Modify with IDAPython</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1662534000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 7, 2022 </em> </span> <span> Updated <em class="" data-ts="1662536503" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 7, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/nth2579">Hai Nguyen</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="919 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><h1 id="lời-nói-đầu">Lời nói đầu</h1><p>Crackme trên do mình tình cờ đọc blog của anh m4n0w4r về writeup có trên <a href="https://forum.tuts4you.com/topic/37666-crackme-find-the-flag-by-extremecoders/">tut4you</a>. Bài này tuy dùng kỹ thuật khá là cổ điển nhưng ít nhiều nó giúp mình có thêm cái nhìn rõ hơn về kỹ thuật <code class="language-plaintext highlighter-rouge">Self Modify</code> mà tác giả đã vận dụng rất sáng tạo.</p><h2 id="giới-thiệu"><span class="mr-2">Giới thiệu</span><a href="#giới-thiệu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Given files:</strong> <a href="https://github.com/MrEn1gma/Writeups/raw/main/Unpack%20me%20if%20you%20can/findtheflag.exe">findtheflag.exe</a><li><strong>Description</strong>: You need to find the flag which will print the good boy message, Everything is allowed.<li><strong>Category</strong>: Reversing<li><strong>Summary</strong>: Tác giả sử dụng kỹ thuật <code class="language-plaintext highlighter-rouge">Self Modify</code> nhằm mã hoá từng phần của instruction sang các bytecode. Bằng cách sử dụng IDAPython, mình sẽ khôi phục lại các instruction về ban đầu.</ul><h2 id="phân-tích-binary"><span class="mr-2">Phân tích binary</span><a href="#phân-tích-binary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Phân tích hàm <code class="language-plaintext highlighter-rouge">main</code>, mình nhận thấy rằng IDA chỉ nhận diện được tới đoạn <code class="language-plaintext highlighter-rouge">popa</code> instruction, còn khúc sau mình nhận thấy nó không giống với instruction thông thường, khả năng cao nó là các bytecodes đã bị mã hoá.</p><p><img data-src="/assets/img/findtheflag_img/self_modify_main.png" alt="main_a" data-proofer-ignore></p><p>Đặt breakpoint tại <code class="language-plaintext highlighter-rouge">pusha (0x40103a)</code> and <code class="language-plaintext highlighter-rouge">popa (0x401055)</code>. Sau đó debug tới địa chỉ <code class="language-plaintext highlighter-rouge">0x401055</code>, nhận thấy rằng 1 phần đầu của bytecode đã được giải mã bằng thuật toán XOR. Tuy nhiên hay nhìn địa chỉ <code class="language-plaintext highlighter-rouge">0x40125a</code> tới địa chỉ <code class="language-plaintext highlighter-rouge">0x401275</code>, mình thấy rằng nó gần giống với block trên và nó sử dụng key xor tận 2 lần. Điều đó có nghĩa là, nếu như mình trace từ block thứ nhất sang block tiếp theo, các bytecode sẽ được giữ nguyên bởi vì 2 lần mã hoá/giải mã đều sử dụng chung key. Để giải thích rõ ràng hơn, mình đã mô phỏng lại cách hoạt động của Crackme này:</p><ul><li>Gọi <code class="language-plaintext highlighter-rouge">STAGE 1</code> là quá trình thực hiện 3 bước <code class="language-plaintext highlighter-rouge">Giải mã -&gt; Thực thi code -&gt; Mã hoá</code> của nhóm bytecodes thứ nhất (chú ý rằng bytecodes mà địa chỉ 0x401056 trở đi nó được chia thành từng nhóm nhỏ để thực hiện theo <code class="language-plaintext highlighter-rouge">STAGE</code>). Nếu mình debug tới STAGE thứ <code class="language-plaintext highlighter-rouge">N</code>, nghĩa là <code class="language-plaintext highlighter-rouge">N - 1</code> STAGE trước đó đã bị modified về các bytecodes ban đầu, hiểu nôm na rằng chương trình ngăn chặn không cho mình xem được full mã giả.</ul><p><img data-src="/assets/img/findtheflag_img/flow_graph.jpg" alt="main_b" data-proofer-ignore></p><h2 id="chiến-thuật"><span class="mr-2">Chiến thuật</span><a href="#chiến-thuật" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><strong>Nhận xét:</strong> Đối với bài này, nếu luớt hết các bytecodes ở dưới, mình thấy có khá là nhiều, chưa kể mình cũng không biết chính xác Crackme này thực hiện bao nhiêu STAGE nên việc debug trong trong trường hợp này là không hiệu quả. Vì vậy sẽ thuận tiện hơn nếu như sử dụng IDAPython để decrypt các bytecodes trên. Vậy thì, để làm được điều này mình cần phải có những thông tin sau:</p><ul><li>Size của nhóm bytecodes: dựa vào pattern <code class="language-plaintext highlighter-rouge">B9</code>, tương ứng với <code class="language-plaintext highlighter-rouge">mov ecx</code>. Từ đó sử dụng hàm <code class="language-plaintext highlighter-rouge">get_operand_value</code> để lấy giá trị của operand thứ 1 cũng chính là giá trị của size bytecode.<li>Key xor của bytecodes: dựa vào pattern <code class="language-plaintext highlighter-rouge">80 34 0E</code> chính là <code class="language-plaintext highlighter-rouge">xor</code>. Cách lấy giá trị keyxor cũng làm tương tự như ở bước trên.<li>Size của nhóm pusha tới popa: dễ dàng nhận thấy có 28 bytes.<li>Bytecodes và địa chỉ tương ứng với các bytes: sau khi có size của nhóm bytecodes và Size của nhóm pusha tới popa thì việc tìm các bytecodes sẽ trở nên dễ dàng hơn. Để ý rằng, bytecodes bắt đầu từ địa chỉ <code class="language-plaintext highlighter-rouge">0x401056</code>, mình sẽ tính được các bytecode kế tiếp bằng cách <code class="language-plaintext highlighter-rouge">lấy địa chỉ đầu tiên của nhóm bytecodes + size của nhóm bytecodes + 56</code>, với 56 là 28 bytes của nhóm pusha/popa + 28 bytes kế tiếp của nhóm pusha/popa đó. Sau đó dùng hàm ida_bytes.patch_bytes để thay thế bằng giá trị của bytecode xor với keyxor tương ứng và nop luôn các block có pusha tới popa.</ul><h2 id="tới-giờ-thực-hiện-rồi-"><span class="mr-2">Tới giờ thực hiện rồi !!!</span><a href="#tới-giờ-thực-hiện-rồi-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Tìm các nhóm bytecodes:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">getGroupOfBytes</span><span class="p">(</span><span class="n">list_size</span><span class="p">):</span>
    <span class="n">start_addr</span> <span class="o">=</span> <span class="n">idaapi</span><span class="p">.</span><span class="n">inf_get_main</span><span class="p">()</span> <span class="o">+</span> <span class="mh">0x56</span> <span class="c1"># start bytecodes
</span>    <span class="n">list_bytes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx_size</span> <span class="ow">in</span> <span class="n">list_size</span><span class="p">:</span>
        <span class="n">list_addrs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_addr</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ida_bytes</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">idx_size</span><span class="p">)]</span>
        <span class="n">list_bytes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">start_addr</span> <span class="o">=</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="n">idx_size</span> <span class="o">+</span> <span class="mi">56</span>
        
    <span class="k">return</span> <span class="n">list_bytes</span><span class="p">,</span> <span class="n">list_addrs</span>
</pre></table></code></div></div><p>Tìm size của bytecode và keyxor:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">search_list_pattern</span><span class="p">(</span><span class="n">startEA</span><span class="p">,</span> <span class="n">endEA</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
    <span class="n">list_addr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span><span class="p">(</span><span class="n">startEA</span> <span class="o">&lt;</span> <span class="n">endEA</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">find_binary</span><span class="p">(</span><span class="n">startEA</span><span class="p">,</span> <span class="n">endEA</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SEARCH_DOWN</span><span class="p">)</span>
        <span class="k">if</span><span class="p">((</span><span class="n">out</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_addr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">out</span> <span class="o">!=</span> <span class="n">ida_idaapi</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xffff</span><span class="p">)):</span>
            <span class="n">list_addr</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">startEA</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">list_addr</span>

<span class="k">def</span> <span class="nf">getValueFromAddr</span><span class="p">(</span><span class="n">list_addr</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx_addr</span> <span class="ow">in</span> <span class="n">list_addr</span><span class="p">:</span>
        <span class="n">out</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">idx_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span> <span class="c1"># each stages do dec/enc at the same stage, dec/enc are used same size of bytes. So I remove one in each stages
</span>        <span class="n">out1</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out1</span>

<span class="n">list_size_of_bytecodes</span> <span class="o">=</span> <span class="n">getValueFromAddr</span><span class="p">(</span><span class="n">search_list_pattern</span><span class="p">(</span><span class="n">main_startEA</span><span class="p">,</span> <span class="n">main_endEA</span><span class="p">,</span> <span class="n">opcode_of_size_bytecodes</span><span class="p">))</span>
<span class="n">list_key_xor</span> <span class="o">=</span> <span class="n">getValueFromAddr</span><span class="p">(</span><span class="n">search_list_pattern</span><span class="p">(</span><span class="n">main_startEA</span><span class="p">,</span> <span class="n">main_endEA</span><span class="p">,</span> <span class="n">opcode_xor</span><span class="p">))</span>
</pre></table></code></div></div><p>Full script mình để ở đây: <a href="https://github.com/MrEn1gma/Writeups/blob/main/Unpack%20me%20if%20you%20can/unpacker.py">unpacker</a></p><h2 id="phân-tích-file-decrypted-unpackeeeerexe"><span class="mr-2">Phân tích file decrypted (unpackeeeer.exe)</span><a href="#phân-tích-file-decrypted-unpackeeeerexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Sau khi chạy script xong, mình đã có được mã giả tương đối đẹp.</p><p><img data-src="/assets/img/findtheflag_img/before_dec_main.png" alt="main_c" data-proofer-ignore></p><p>Đối với mình thì mã giả trên chưa thật sự “đẹp” cho lắm, cho nên mình đã chỉnh lại cái size của <code class="language-plaintext highlighter-rouge">char Buffer[4]</code> thành <code class="language-plaintext highlighter-rouge">char Buffer[31]</code> (vì nhìn vào input ta thấy được hàm gets lấy tối đa là 31 bytes), lúc này mã giả trông đẹp hơn.</p><p><img data-src="/assets/img/findtheflag_img/after_dec_main.png" alt="main_c" data-proofer-ignore></p><p>Về tổng quan chương trình mới là 1 đống hệ phương trình tuyến tính, mình không mất quá nhiều thời gian để giải tay, trực tiếp quăng nó vô z3 solver và giải ra nghiệm và grep lại thành flag.</p><p>Full script solve <a href="https://github.com/MrEn1gma/Writeups/blob/main/Unpack%20me%20if%20you%20can/solve.py">solve.py</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/re/'>RE</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/selfmodify/" class="post-tag no-text-decoration" >selfmodify</a> <a href="/tags/idapython/" class="post-tag no-text-decoration" >idapython</a> <a href="/tags/z3/" class="post-tag no-text-decoration" >z3</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=findtheflag.exe+-+defeating+custom+Self+Modify+with+IDAPython+-+Hai+Nguyen&url=https%3A%2F%2Fmren1gma.github.io%2Fposts%2Ffindtheflag-extremecoder%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=findtheflag.exe+-+defeating+custom+Self+Modify+with+IDAPython+-+Hai+Nguyen&u=https%3A%2F%2Fmren1gma.github.io%2Fposts%2Ffindtheflag-extremecoder%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmren1gma.github.io%2Fposts%2Ffindtheflag-extremecoder%2F&text=findtheflag.exe+-+defeating+custom+Self+Modify+with+IDAPython+-+Hai+Nguyen" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Coconut-ASCIS-CTF-2022/">Coconut - ASCIS CTF 2022</a><li><a href="/posts/findtheflag-extremecoder/">findtheflag.exe - defeating custom Self Modify with IDAPython</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ascis/">ascis</a> <a class="post-tag" href="/tags/idapython/">idapython</a> <a class="post-tag" href="/tags/obfuscation/">Obfuscation</a> <a class="post-tag" href="/tags/selfmodify/">selfmodify</a> <a class="post-tag" href="/tags/z3/">z3</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Coconut-ASCIS-CTF-2022/"><div class="card-body"> <em class="small" data-ts="1666184400" data-df="ll" > Oct 19, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Coconut - ASCIS CTF 2022</h3><div class="text-muted small"><p> Lời nói đầu Vòng loại giải Sinh Viên An Toàn Thông Tin ASEAN đã kết thúc vào ngày 15/10. Đó là ngày đáng nhớ của mình cũng như các bạn khác tham gia vào ngày hôm đó, team mình - th++ đã cố...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"><div class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></div><a href="/posts/Coconut-ASCIS-CTF-2022/" class="btn btn-outline-primary" prompt="Newer"><p>Coconut - ASCIS CTF 2022</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/nth2579">Hai Nguyen</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ascis/">ascis</a> <a class="post-tag" href="/tags/idapython/">idapython</a> <a class="post-tag" href="/tags/obfuscation/">Obfuscation</a> <a class="post-tag" href="/tags/selfmodify/">selfmodify</a> <a class="post-tag" href="/tags/z3/">z3</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
